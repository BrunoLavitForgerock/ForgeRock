<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>

<body>

    <script>
        let _isSafari = false;
        var ua = navigator.userAgent.toLowerCase();
        if (ua.indexOf('safari') != -1) {
            if (ua.indexOf('chrome') > -1) {
            } else if (ua.indexOf('mac') != -1) {
                _isSafari = true;
            }
        }
        const _serverUrl = _isSafari ? "https://127.0.0.1:31414" : "http://127.0.0.1:31415";

        const token = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1bmlxdWVfbmFtZSI6IkhIR05USiIsImh0dHA6Ly9zY2hlbWFzLnhtbHNvYXAub3JnL3dzLzIwMDUvMDUvaWRlbnRpdHkvY2xhaW1zL2F1dGhvcml6YXRpb25kZWNpc2lvbiI6IjdCV1oiLCJwcmltYXJ5c2lkIjoidXNlcm1hbiIsImdlbmRlciI6IjxSU0FLZXlWYWx1ZT48TW9kdWx1cz5yUkNZWXI0VDc5R0k3QWdsYXlHYjFHVkdBZk1SQ3pITWd3NUxDNmRGM21QVDJJeCtHNzVwbzJKLy9GN3IzRWdNdDJ2eXcrbThvYktlbHBmSUIzNENnMHZQTkFLbzFSVjBBMk8ydDFxZWc4RVlXUnIvQWtiWG9DdGhyQVhabitJNGtvS3ltT25pSjJad25aNkdqT09GQmwzMk5OTHBuSnZiQnRmT1JzWHFIVGJMNEhZOXRzcXloTVQvNmRrcDhvQzdYNXZjeTYyZldOY1AvRmYyS0hkdHFBckg1dkcrUGcxbTZhc3NIRngrT0t6Wms3K3g4djFNOWNka3hzS1BvYUJETzFIRFlUckJCcDZoUVBnOXlYdnNqT3htaFhpUndnZjFsS1V1RDVLKzNjWmt1TlAybnIwNkRuRW1uRmF2MjdYeXA2OVBROGdXa2R3R0hUSUV5ejZvc1VYendUWXZ4VHdMdk1IMkFVb3ZMZlNVY1FaMFFnb0JwcTk2TlF0WE9CTUxsRmFNb0hDYk5tVDczdjVMaCtNRzdBdWFsSy9pYUdqY0p1eUlCZ05TcmwzOE9JNklrVHd6Z2FhT0dOcnlhUXhXd0FpN1RoRm1Bc2VkMXhXdW4yb0dUYlJ4cGJpRXBHbE9lTS85eFN2MnRUL2pmeFNac3BFcUErSnNtaFFORVZlUDFtcHdsZi9DQTJhcXMyaWxJRWQxZ1pWVUc0S3JRQUl0MjZYTmVjL1VRUm9waHFXTDNWN3JEYzRZZzRla1hzbDMzZHdnblVyWXRiSzRrcjNPMFlDcVJlTlFqbkhnVld1TW9xZTNVUHduOGlzY1VSWlBXbDNITzZ4RlVta2t2YmFOcnhwbkp0bzUyVkxEQnFWVXRTaDdIZS9XQmlManVKam1vd1hpczIxNTRtMD08L01vZHVsdXM-PEV4cG9uZW50PkFRQUI8L0V4cG9uZW50PjwvUlNBS2V5VmFsdWU-IiwiaHR0cDovL3NjaGVtYXMubWljcm9zb2Z0LmNvbS93cy8yMDA4LzA2L2lkZW50aXR5L2NsYWltcy91c2VyZGF0YSI6IntcIkNyb3NzQ3VzdG9tZXJFeGNlcHRpb25zXCI6XCJcIn0iLCJuYmYiOjE2MzQyMzkwOTMsImV4cCI6MTYzNDIzOTY5MywiaWF0IjoxNjM0MjM5MDkzfQ.JJJizk6wnsz4apBmyN2c_bWnT7l8MbQarXn7hIHiSgw';
        const appKey = 'appKey_PgRBg5gfXLZUQBUJ39VqkJyyLqopmSWjp';


        const header = new Headers({
            'x-circle-appkey': appKey,
            'Authorization': 'Bearer ' + token,
            'Accept': 'application/json',
            'Content-Type': 'application/json; charset=utf-8'
        });

        var Circle = {

            isAutorized: false,
            authorize: async function () {
                const body = {
                    Token: token,
                }

                return fetch(_serverUrl + '/v1/authorize', {
                    method: "POST",
                    headers: new Headers({
                        'x-circle-appkey': appKey,
                        'Accept': 'application/json',
                        'Content-Type': 'application/json; charset=utf-8'
                    }),
                    body: JSON.stringify(body)
                }).then(async res => {
                    const data = JSON.parse(await res.text());
                    this.isAutorized = data.Status.Result;
                    return this.isAutorized;
                }).catch(err => {
                    return false;
                });
            },
            enumCircles: async () => {

                const body = {};

                return fetch(_serverUrl + '/v1/enumCircles', {
                    method: "POST",
                    headers: header,
                    body: JSON.stringify(body)
                }).then(async res => {
                    const data = JSON.parse(await res.text());
                    return data;
                });

            },
            enumTopics: async function (CircleId) {
                const body = {
                    CircleId
                };

                return fetch(_serverUrl + '/v1/enumTopics', {
                    method: "POST",
                    headers: header,
                    body: JSON.stringify(body)
                }).then(async res => {
                    const data = JSON.parse(await res.text());
                    return data;
                });
            },
            addMessage: async function (CircleId, TopicId, MessageType, MessageSubType, Message,
                Context, ObjectPath, Base64Data, AdditionalJson) {
                const body = {
                    CircleId, TopicId, MessageType, MessageSubType, Message, Context, ObjectPath,
                    Base64Data, AdditionalJson
                };

                return fetch(_serverUrl + '/v1/addMessage', {
                    method: "POST",
                    headers: header,
                    body: JSON.stringify(body)
                }).then(async res => {
                    const data = JSON.parse(await res.text());
                    return data;
                });
            },
            getMessages: async function (CircleId, TopicId, MsgTypeFilters) {
                const body = {
                    CircleId, TopicId, MsgTypeFilters
                };

                return fetch(_serverUrl + '/v1/getMessages', {
                    method: "POST",
                    headers: header,
                    body: JSON.stringify(body)
                }).then(async res => {
                    const data = JSON.parse(await res.text());
                    return data;
                });
            }
        }

        const checkIsAuthorized = function () {
            if (!Circle.isAutorized) {
                throw 'Not authorized'
            }
        };

        async function getCircleAndTopic() {

            checkIsAuthorized();

            const allCircles = await Circle.enumCircles();
            if (!allCircles || !allCircles.Status.Result || !allCircles.CircleMeta || !allCircles.CircleMeta.length) {
                throw "Cant retrieve Circle";
            }

            const firstCircle = allCircles.CircleMeta[0];

            const allTopics = await Circle.enumTopics(firstCircle.CircleId);
            if (!allTopics || !allTopics.Status.Result || !allTopics.Topics || !allTopics.Topics.length) {
                throw "Cant retrieve Topic";
            }

            const firstTopic = allTopics.Topics[0];
            return {
                CircleId: firstCircle.CircleId,
                TopicId: firstTopic.TopicId,
            };
        }

        async function getCircleSavedToken(tokenType) {
            checkIsAuthorized();

            const circleTopicData = await getCircleAndTopic();
            if (!circleTopicData) {
                return null;
            }

            const allMessages = await Circle.getMessages(circleTopicData.CircleId, circleTopicData.TopicId, [100]);
            if (!allMessages || !allMessages.Status.Result || !allMessages.Messages) {
                throw ("Cant retrieve Messages");
            }
            for (let index = allMessages.Messages.length - 1; index >= 0; index--) {
                const messageData = allMessages.Messages[index];
                if (messageData.Message && messageData.AdditionalJson && JSON.parse(messageData.AdditionalJson).type === tokenType) {
                    return messageData.Message;
                }
            }
            return null;
        }

        async function saveTokenToCircle(tokenType, data) {
            checkIsAuthorized();

            const circleTopicData = await getCircleAndTopic();
            if (!circleTopicData) {
                return false;
            }
            const addMessage = await Circle.addMessage(circleTopicData.CircleId, circleTopicData.TopicId, //
                100, 20, data, "", "", "", JSON.stringify({ type: tokenType }));
        }

        async function isAuthorizedNode() {
            const isAuthorizedNode = await Circle.authorize();
            return isAuthorizedNode
        }
    </script>

    <script>


        let retorno = async () => {

            const isAuthorized = await isAuthorizedNode();
            //const isSaved = await saveTokenToCircle('forge_rock_auth_id', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1bmlxdWVfbmFtZSI6IkhIR05USiIsImh0dHA6Ly9zY2hlbWFzLnhtbHNvYXAub3JnL3dzLzIwMDUvMDUvaWRlbnRpdHkvY2xhaW1zL2F1dGhvcml6YXRpb25kZWNpc2lvbiI6IjdCV1oiLCJwcmltYXJ5c2lkIjoidXNlcm1hbiIsImdlbmRlciI6IjxSU0FLZXlWYWx1ZT48TW9kdWx1cz5yUkNZWXI0VDc5R0k3QWdsYXlHYjFHVkdBZk1SQ3pITWd3NUxDNmRGM21QVDJJeCtHNzVwbzJKLy9GN3IzRWdNdDJ2eXcrbThvYktlbHBmSUIzNENnMHZQTkFLbzFSVjBBMk8ydDFxZWc4RVlXUnIvQWtiWG9DdGhyQVhabitJNGtvS3ltT25pSjJad25aNkdqT09GQmwzMk5OTHBuSnZiQnRmT1JzWHFIVGJMNEhZOXRzcXloTVQvNmRrcDhvQzdYNXZjeTYyZldOY1AvRmYyS0hkdHFBckg1dkcrUGcxbTZhc3NIRngrT0t6Wms3K3g4djFNOWNka3hzS1BvYUJETzFIRFlUckJCcDZoUVBnOXlYdnNqT3htaFhpUndnZjFsS1V1RDVLKzNjWmt1TlAybnIwNkRuRW1uRmF2MjdYeXA2OVBROGdXa2R3R0hUSUV5ejZvc1VYendUWXZ4VHdMdk1IMkFVb3ZMZlNVY1FaMFFnb0JwcTk2TlF0WE9CTUxsRmFNb0hDYk5tVDczdjVMaCtNRzdBdWFsSy9pYUdqY0p1eUlCZ05TcmwzOE9JNklrVHd6Z2FhT0dOcnlhUXhXd0FpN1RoRm1Bc2VkMXhXdW4yb0dUYlJ4cGJpRXBHbE9lTS85eFN2MnRUL2pmeFNac3BFcUErSnNtaFFORVZlUDFtcHdsZi9DQTJhcXMyaWxJRWQxZ1pWVUc0S3JRQUl0MjZYTmVjL1VRUm9waHFXTDNWN3JEYzRZZzRla1hzbDMzZHdnblVyWXRiSzRrcjNPMFlDcVJlTlFqbkhnVld1TW9xZTNVUHduOGlzY1VSWlBXbDNITzZ4RlVta2t2YmFOcnhwbkp0bzUyVkxEQnFWVXRTaDdIZS9XQmlManVKam1vd1hpczIxNTRtMD08L01vZHVsdXM-PEV4cG9uZW50PkFRQUI8L0V4cG9uZW50PjwvUlNBS2V5VmFsdWU-IiwiaHR0cDovL3NjaGVtYXMubWljcm9zb2Z0LmNvbS93cy8yMDA4LzA2L2lkZW50aXR5L2NsYWltcy91c2VyZGF0YSI6IntcIkNyb3NzQ3VzdG9tZXJFeGNlcHRpb25zXCI6XCJcIn0iLCJuYmYiOjE2MzM3MjE1MDMsImV4cCI6MTYzMzcyMjEwMywiaWF0IjoxNjMzNzIxNTAzfQ.Eg7yPfLezivHC4W19TQrCQagqz6x-wGyTlMmFLcTqG4');

            console.log("Autorize: " + isAuthorized);
            //console.log("Saved: " + isSaved);

            const customerCode = "HHGNTJ"
            //  const allCircles = await Circle.enumCircles(customerCode);
            //  if (!allCircles || !allCircles.Status.Result || !allCircles.CircleMeta || !allCircles.CircleMeta.length) {
            //      throw "Cant retrieve Circle";
            // }

            // await saveTokenToCircle("MyToken", "MyToken-" + appKey);

            //var msg = await getCircleSavedToken('forgerock');
            //console.log("forgerock token: " + msg);

            let msg = await getCircleSavedToken('forge_rock_refresh2');

            console.log("forge_rock_refresh2:");
            console.log(msg);

            return null;
        }
        retorno();

    </script>
</body>

</html>